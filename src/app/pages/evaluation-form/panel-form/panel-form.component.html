<div class="body-white">
    <app-header-text context="table-header" [nopad]="true">
      Technical Evaluation Sheet
    </app-header-text>

    <div class="container">

      <!-- ===== LOADING STATE ===== -->
      <div *ngIf="formState === 'loading'" class="status-box">
        <h3>{{ statusMessage }}</h3>
      </div>

      <!-- ===== INVALID/SUBMITTED STATE ===== -->
      <div *ngIf="formState === 'invalid' || formState === 'submitted'" class="status-box">
        <h2>{{ formState === 'submitted' ? 'Thank You!' : 'Link is Not Valid' }}</h2>
        <p>{{ statusMessage }}</p>
      </div>
      
      <!-- ===== READY STATE (THE FORM) ===== -->
      <div *ngIf="formState === 'ready' && evaluationForm">
        
        <div class="form-header">
          <h3>Evaluation for {{ formDetails?.candidateName }}</h3>
          <p><strong>Role:</strong> {{ formDetails?.jobRole }} | <strong>Level:</strong> {{ formDetails?.interviewLevel }}</p>
          <p class="prompt">{{ formDetails?.interviewerPrompt }}</p>
          <hr>
        </div>

        <form [formGroup]="evaluationForm" (ngSubmit)="onSubmit()">
          
          <!-- Candidate Info Section (Read-only) -->
          <div class="form-section" formGroupName="summary">
            <table class="candidate-info">
              <tr>
                <td>Candidate Name:</td>
                <td><input type="text" formControlName="candidateName"></td>
                <td>Technology:</td>
                <td><input type="text" formControlName="technology"></td>
              </tr>
              <tr>
                <td>Interview Level:</td>
                <td><input type="text" formControlName="interviewLevel"></td>
                <td>Notice Period:</td>
                <td><input type="text" formControlName="noticePeriod"></td>
              </tr>
              <tr>
                <td>Total Experience:</td>
                <td><input type="text" formControlName="totalExperience"></td>
                <td>Relevant Experience:</td>
                <td><input type="text" formControlName="relevantExperience"></td>
              </tr>
              <tr>
                <td>Current Location:</td>
                <td><input type="text" formControlName="currentLocation"></td>
                <td>Preferred Location:</td>
                <td><input type="text" formControlName="preferredLocation"></td>
              </tr>
            </table>
          </div>

          <!-- Technical Evaluation Section -->
          <div class="form-section" formArrayName="skills">
            <div class="section-title">Technical Evaluation</div>
            <div *ngFor="let skillGroup of skills.controls; let i = index" [formGroupName]="i" class="skill-block">
              <div class.highlight>{{ skillGroup.get('category')?.value }}</div>
              <table class="skills-table">
                <thead>
                  <tr>
                    <th>Technical Skills</th>
                    <th>Candidate Self Rating</th>
                    <th>Knowledge (Rating)</th>
                    <th>Skills (Rating)</th>
                    <th>Implementation (Rating)</th>
                    <th>Average Rating</th>
                  </tr>
                </thead>
                <tbody formArrayName="competencies">
<tr *ngFor="let competencyGroup of $any(skillGroup.get('competencies')).controls; let j = index" [formGroupName]="j">                    <td><input type="number" class="rating-input" formControlName="selfRating"></td>
                    <td><input type="number" class="rating-input" formControlName="knowledgeRating"></td>
                    <td><input type="number" class="rating-input" formControlName="skillsRating"></td>
                    <td><input type="number" class="rating-input" formControlName="implementationRating"></td>
                    <td><input type="number" class="rating-input" formControlName="averageRating"></td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td>Comments</td>
                    <td colspan="5"><textarea formControlName="comments" rows="3"></textarea></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- CAR Behavioral Interview Section -->
          <div class="form-section" formArrayName="capabilities">
            <div class="section-title">CAR (Context-Action-Results) Behavioral Interview</div>
            <table class="car-table">
              <thead>
                <tr>
                  <th>Question addressing Capability</th>
                  <th>Context (Take relevant notes)</th>
                  <th>Action (Take relevant notes)</th>
                  <th>Results (Take relevant notes)</th>
                  <th>Rating (1-5)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let capabilityGroup of capabilities.controls; let i = index" [formGroupName]="i">
                  <td>*{{ capabilityGroup.get('question')?.value }}</td>
                  <ng-container *ngIf="!capabilityGroup.get('fullComment')">
                    <td><textarea formControlName="context" rows="4"></textarea></td>
                    <td><textarea formControlName="action" rows="4"></textarea></td>
                    <td><textarea formControlName="result" rows="4"></textarea></td>
                    <td><input type="number" class="rating-input" formControlName="rating"></td>
                  </ng-container>
                  <td *ngIf="capabilityGroup.get('fullComment')" colspan="4">
                    <textarea formControlName="fullComment" rows="5"></textarea>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Overall Assessment Section -->
          <!-- Overall Assessment Section -->
<div class="form-section" formGroupName="feedback">
  <div class="section-title">Overall Assessment</div>
  <table>
    <tr><td>Describe the candidate's strengths: *</td></tr>
    <tr><td><textarea formControlName="strengths" rows="4"></textarea></td></tr>
    <tr><td>Describe the candidate's willingness to learn and adapt (Learnability): *</td></tr>
    <tr><td><textarea formControlName="learnability" rows="4"></textarea></td></tr>
    <tr><td>Describe the candidate's areas for improvement: *</td></tr>
    <tr><td><textarea formControlName="improvementAreas" rows="4"></textarea></td></tr>

    <!-- MODIFICATION: Reverted this back to a simple textarea as per your JSON. -->
    <tr><td>Do you feel this candidate has the capabilities needed to be successful in this role? *</td></tr>
    <tr><td><textarea formControlName="hasCapabilities" rows="4"></textarea></td></tr>

    <tr><td>If Yes (Provide justification):</td></tr>
    <tr><td><textarea formControlName="justificationIfYes" rows="4"></textarea></td></tr>
    <tr><td>If No (Provide Feedback):</td></tr>
    <tr><td><textarea formControlName="feedbackIfNo" rows="4"></textarea></td></tr>
    <tr><td>Additional observations/thoughts:</td></tr>
    <tr><td><textarea formControlName="additionalObservations" rows="4"></textarea></td></tr>
    <tr><td>Interview Notes:</td></tr>
    <tr><td><textarea formControlName="interviewNotes" rows="4"></textarea></td></tr>
  </table>
</div>

<!-- Footer & Submission Section -->
<div class="form-section" formGroupName="finalSubmission">
  <div class="section-title">Final Decision</div>
  <table>
    <tr>
      <td><strong>Hiring Decision: *</strong></td>
      <td>
        <!-- MODIFICATION: Added a disabled "Select" option with an empty value. -->
        <!-- This is the standard way to make a <select> element required. -->
        <select formControlName="hiringDecision">
          <option value="" disabled>-- Select a Decision --</option>
          <option>Select</option> <!-- "Select" seems to be a valid value for your backend -->
          <option>On Hold</option>
          <option>Reject</option>
          <option>Consider for other positions</option>
        </select>
      </td>
      <td><strong>Proposed Role:</strong></td>
      <td><input type="text" formControlName="proposedRole"></td>
    </tr>
              <tr>
                <td><strong>Interviewer Name: *</strong></td>
                <td><input type="text" formControlName="interviewerName"></td>
                <td><strong>Interviewer Emp ID:</strong></td>
                <td><input type="text" formControlName="interviewerEmpId"></td>
              </tr>
              <tr>
                <td><strong>Your Email Address: *</strong></td>
                <td colspan="3"><input type="email" formControlName="submittedByEmail"></td>
              </tr>
            </table>
          </div>

          <div class="form-actions">
            <app-button type="submit" [disabled]="evaluationForm.invalid">Submit Evaluation</app-button>
          </div>
        </form>
      </div>
    </div>
</div>