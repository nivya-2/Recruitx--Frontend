<app-common-layout
[breadcrumbItems]="items"
>
  <app-cards class="custom-padding"> 
    <app-header-text context="table-header" [nopad]="true">Scheduler</app-header-text>

<div class="interview-scheduling-container ">
  <div class="flex-test  center-test gap">
    
    <div class="name-level">
      <div class=" mb-4">
        <label for="candidateDropdown" class="block font-medium mb-2"></label>
        <p-dropdown 
          inputId="candidateDropdown"
          [options]="candidates" 
          [(ngModel)]="selectedCandidate" 
          optionLabel="name" 
          placeholder="Search candidate here"
          [filter]="true" 
          filterBy="name" 
          appendTo="self"
          [showClear]="true" 
          (onChange)="onCandidateChange($event)" 
          name="selectedCandidateDropdown"
          class="w-full select-candi sel-candi"
          #candidateDropdownModel="ngModel">
          <ng-template pTemplate="selectedItem">
              <div class="flex align-items-center gap-2" *ngIf="selectedCandidate">
                  <div>{{selectedCandidate.name}}</div>
              </div>
          </ng-template>
          <ng-template let-candidate pTemplate="item">
              <div class="flex align-items-center gap-2">
                  <div>{{candidate.name}} <span class="text-sm text-500"></span></div>
              </div>
          </ng-template>
        </p-dropdown>
      </div>
      <h2 class="text-xl font-semibold mb-4 cent-text">
        {{ selectedCandidate?.name || 'Select Candidate' }}
        <span *ngIf="selectedCandidate" class="font-medium text-base ml-2 level-font">
          ({{ selectedCandidate.stage }})
        </span>
      </h2>
    </div>
    
    
  </div>

  <div class="flex-test flex-col gap-4 h-full">
    
    <div class="flex-1 p-4">
      
      <div class="flex flex-test gap-card">
        
        <!-- Scheduling Form (Left Side) -->
        <div class="col-12 lg:col-6">
          
          <div class="card card1">
            <form #schedulingForm="ngForm">
             
              <div class="field mb-4 height-int">
                <label class="block font-medium mb-2">Interviewers *</label>
                <p-multiSelect 
                  [(ngModel)]="selectedInterviewers" 
                  name="interviewers"
                  [options]="interviewers" 
                  optionLabel="name" 
                  optionValue="id"
                  [selectionLimit]="3"
                  placeholder="Select interviewers"
                  (onChange)="onInterviewersChange()"
                  class="w-full"
                  #interviewersModel="ngModel" required>
                  <ng-template let-interviewer pTemplate="item">
                    <div class="flex align-items-center gap-2">
                      <span>{{ interviewer.name }}</span>
                    </div>
                  </ng-template>
                </p-multiSelect>
                <small class="text-500">Select up to 3 interviewers</small> <br>
                <!-- <small *ngIf="interviewersModel.invalid && (interviewersModel.dirty || interviewersModel.touched) && (!selectedInterviewers || selectedInterviewers.length === 0)" class="p-error">At least one interviewer is required.</small> -->
              </div>
              <div class="field">
                <label class="block font-medium mb-2">Date *</label>
                <p-calendar 
                  [(ngModel)]="selectedDate" 
                  name="date"
                  [minDate]="minDate"
                  [showIcon]="true"
                  dateFormat="dd/mm/yy"
                  (onSelect)="onDateChange()"
                  placeholder="Select date"
                  class="w-full date-pick"
                  #dateModel="ngModel" required>
                </p-calendar>
                <small *ngIf="dateModel.invalid && (dateModel.dirty || dateModel.touched)" class="p-error">Date is required.</small>
              </div>
              <div class="form-row mb-4">
                  <div class="field">
                    <label class="block font-medium mb-2">Time *</label>
                    <p-dropdown 
                      [(ngModel)]="selectedStartTime" 
                      name="startTime"
                      [options]="timeSlots" 
                      optionLabel="label" 
                      optionValue="value"
                      placeholder="Starting"
                      (onChange)="onTimeChange()"
                      class="w-full "
                      #startTimeModel="ngModel" required>
                    </p-dropdown>
                    <small *ngIf="startTimeModel.invalid && (startTimeModel.dirty || startTimeModel.touched)" class="p-error">Start time is required.</small>
                  </div>
                  <div class="field">
                    <label class="empty-label">Time</label>
                    <p-dropdown 
                      [(ngModel)]="selectedEndTime" 
                      name="endTime"
                      [options]="filteredEndTimeSlots" 
                      optionLabel="label" 
                      optionValue="value"
                      placeholder="Ending"

                      (onChange)="calculateCurrentMeetingDuration(); checkForConflicts()"                      class="w-full"
                      #endTimeModel="ngModel" required>
                    </p-dropdown>
                    <small *ngIf="endTimeModel.invalid && (endTimeModel.dirty || endTimeModel.touched)" class="p-error">End time is required.</small>
                  </div>
                </div>

             

              <div *ngIf="conflicts.length > 0" class="mb-4">
                <p-message 
                  severity="warn" 
                  text="Schedule conflicts detected!"
                  class="w-full">
                </p-message>
                <!-- <div class="mt-2">
                  <div *ngFor="let conflict of conflicts" class="text-sm text-orange-600 mb-1">
                    â€¢ {{ conflict }}
                  </div>
                </div> -->
              </div>
              
              <div *ngIf="selectedCandidate">
                    <div class="details-container">
                      <div class="row">
                        <div class="label">Mobile Number </div>
                        <div class="value">{{ selectedCandidate.mobNumber }}</div>
                      </div>
                      <div class="row">
                        <div class="label">Total Experience </div>
                        <div class="value">{{ selectedCandidate.totalExp }} years</div>
                      </div>
                      <div class="row">
                        <div class="label">Relevant Experience </div>
                        <div class="value">{{ selectedCandidate.relevantExp }} years</div>
                      </div>
                      <div class="row">
                        <div class="label">Current Employer </div>
                        <div class="value">{{ selectedCandidate.currentEmployer }}</div>
                      </div>
                    </div>
              </div>
                
              <div class="flex justify-content-end mt-4 btn-lst ">
               <app-button (functionemit)="scheduleAlert($event)"                   
                [disabled]="!canSchedule() || schedulingForm.invalid || !selectedCandidate" >Schedule Meeting</app-button>

              </div>
            </form>
          </div>
        </div>
        <!-- Schedule Display (NEW GRID LAYOUT - Right Side) -->
        <div class="col-12 lg:col-6 ">
          
          <div class="card card-2 card-width">
            
            <div class="flex justify-content-between align-items-center mb-4 schedule-display-header flex-test padding">
              <app-button (functionemit)="previousDay()" class="btn-cls">
                <app-icon name="keyboard_arrow_left" size="28px" customColor="#ffff"></app-icon>
              </app-button>
              <h3 class="schedule-time">
                 Schedule for
                 <div> {{ selectedDate | date:'EEEE, MMMM d, yyyy' }}</div>
              </h3>
              <app-button (functionemit)="nextDay()" class="btn-cls">
                <app-icon name="keyboard_arrow_right" size="28px" customColor="#ffff"></app-icon>
              </app-button>
            </div>
        
            <div *ngIf="!selectedInterviewers || selectedInterviewers.length === 0" class="text-center text-500 py-4 pos-alt">
              Select interviewers to view their schedules
            </div>
        
            <div *ngIf="selectedInterviewers && selectedInterviewers.length > 0" 
                 class="schedule-grid-wrapper "
                 [style.--interviewer-count]="selectedInterviewers.length">
              <div class="schedule-grid-container ">
                <!-- Grid Header: Empty Top-Left + Interviewer Names -->
                <div class="grid-header-cell time-axis-header"></div> <!-- Top-left empty cell -->
                <div *ngFor="let interviewerId of selectedInterviewers" class="grid-header-cell interviewer-name-header">
                  <div >{{ getInterviewerName(interviewerId) }}</div>
                  <div> <span class="interviewer-subname" *ngIf="currentMeetingDuration > 0"> {{ formatDurationDisplay(currentMeetingDuration) }}</span></div> <!-- TODO: Make dynamic if needed -->
                </div>

                <!-- All Day Row -->
                <!-- <div class="grid-cell all-day-label">All Day</div>
                <div *ngFor="let interviewerId of selectedInterviewers" class="grid-cell all-day-slot">
                </div> -->

                <!-- Time Rows -->
                <ng-container *ngFor="let hour of displayHours">
                  <div class="grid-cell time-label">{{ formatHourForDisplay(hour) }}</div>
                  <div *ngFor="let interviewerId of selectedInterviewers" 
                       class="grid-cell timeslot-cell"
                       [class.non-working-hours]="!isWorkingHour(hour)"  >
                    <!-- Event Blocks will be positioned absolutely within this cell -->
                    <div *ngFor="let event of getEventsForCell(interviewerId, hour)"
                         class="event-block"
                         [style.top]="calculateEventTopPosition(event, hour)"
                         [style.height]="calculateEventHeight(event, hour)"
                         [ngClass]="{
                             'current-candidate-event': selectedCandidate && event.candidateId === selectedCandidate.id,
                             'other-candidate-event': !selectedCandidate || (selectedCandidate && event.candidateId !== selectedCandidate.id)
                         }"
                         title="{{event.candidateName}}: {{formatEventTimeForBlock(event.startTime)}}-{{formatEventTimeForBlock(event.endTime)}}">
                         {{ formatEventTimeForBlock(event.startTime) }}-{{ formatEventTimeForBlock(event.endTime) }}
                    </div>
                    <div *ngIf="isTentativePreviewVisibleInCell(hour)"
                    class="tentative-preview-block"
                    [style.top]="calculateTentativePreviewTopPosition(hour)"
                    [style.height]="calculateTentativePreviewHeight(hour)">
               </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<p-toast></p-toast>   
      <app-alerts #alerts></app-alerts>

</div>
</app-cards>
</app-common-layout>